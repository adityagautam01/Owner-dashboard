<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Owner Dashboard - MR.T Cafe</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --primary: #f5576c;
      --secondary: #4facfe;
      --success: #00b894;
      --warning: #fdcb6e;
      --dark: #2d3436;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: #f0f2f5; min-height: 100vh; color: var(--dark); }

    .top-navbar {
      background: white; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 1000;
    }
    .nav-logo { 
      font-size: 1.4rem; font-weight: 800; color: var(--primary); line-height: 1; cursor: pointer; transition: 0.3s;
      display: flex; align-items: center; gap: 10px;
    }
    .nav-logo:hover { 
      transform: scale(1.02); opacity: 0.8; 
      text-decoration: underline;
    }
    
    .nav-user-zone { display: flex; align-items: center; gap: 15px; }
    .logout-btn {
      background: #fff5f5; color: #ff4757; border: 1px solid #ff4757; padding: 8px 18px;
      border-radius: 25px; cursor: pointer; font-weight: 600; transition: 0.3s; display: flex; align-items: center; gap: 8px;
    }
    .logout-btn:hover { background: #ff4757; color: white; box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3); }

    .stats-grid { max-width: 1200px; margin: 25px auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; padding: 0 20px; }
    .stat-box { background: white; padding: 20px; border-radius: 18px; display: flex; align-items: center; gap: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.04); transition: 0.3s; }
    .stat-box:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    .stat-icon { width: 55px; height: 55px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; color: white; }

    .dashboard-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .filter-bar { background: white; padding: 12px; border-radius: 15px; margin-bottom: 25px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .tab-btn { padding: 10px 25px; border: none; border-radius: 30px; font-weight: 600; cursor: pointer; background: #f1f2f6; color: #747d8c; transition: 0.3s; }
    .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(245, 87, 108, 0.3); }

    .order-card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); border-left: 8px solid var(--primary); animation: fadeIn 0.4s ease; }
    .order-card.confirmed { border-left-color: var(--success); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .action-btn { padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .btn-edit { background: #fff9e6; color: #ff9f43; border: 1px solid #ff9f43; }
    .btn-confirm { background: var(--success); color: white; }
    .btn-delete { background: #fee; color: #e74c3c; border: 1px solid #e74c3c; }
    .action-btn:hover { opacity: 0.9; transform: scale(1.02); }

    .login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
    .login-card { background: white; padding: 45px; border-radius: 30px; width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal.active { display: flex; }
    .modal-content { background: white; width: 90%; max-width: 450px; border-radius: 25px; padding: 30px; position: relative; max-height: 85vh; overflow-y: auto; }

    .refresh-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 0.85rem;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,184,148,0.3);
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 999;
    }
    .refresh-indicator.show { display: flex; }

    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .btn-group { grid-template-columns: 1fr; }
      .login-card { width: 90%; }
    }
  </style>
</head>
<body>

  <div class="login-screen" id="loginContainer">
    <div class="login-card">
      <div style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"><i class="fa-solid fa-lock"></i></div>
      <h2 style="margin-bottom:10px;">MR.T Cafe Dashboard</h2>
      <p style="color: #888; margin-bottom: 25px;">Enter your secret PIN to access</p>
      <input type="password" id="ownerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%; padding:15px; border-radius:12px; border:2px solid #eee; text-align:center; font-size:1.5rem; letter-spacing: 5px; margin-bottom:20px; outline: none;">
      <button onclick="login()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer; font-size: 1.1rem;">Unlock System</button>
    </div>
  </div>

  <div class="dashboard" id="dashboard" style="display:none;">
    
    <nav class="top-navbar">
      <div class="nav-logo" onclick="goToMenu()" title="Go to Menu">
        <i class="fa-solid fa-utensils" style="font-size: 1.2rem;"></i>
        MR.T CAFE 
        <span style="font-size:0.7rem; color:#888; font-weight: 400; margin-left: 5px;">(Click to go back to Menu)</span>
      </div>
      
      <div class="nav-user-zone">
        <div style="background: #f1f2f6; padding: 5px 12px; border-radius: 10px; font-size: 0.9rem; font-weight: 600;">
            <i class="fa-solid fa-user-shield" style="color: var(--primary);"></i> Admin
        </div>
        <button class="logout-btn" onclick="logout()">
            <i class="fa-solid fa-power-off"></i> Logout
        </button>
      </div>
    </nav>

    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-icon" style="background:var(--secondary);"><i class="fa-solid fa-receipt"></i></div>
        <div><h3>Total Orders</h3><p id="statTotal" style="font-size: 1.8rem; font-weight: bold; color: var(--dark);">0</p></div>
      </div>
      <div class="stat-box">
        <div class="stat-icon" style="background:var(--success);"><i class="fa-solid fa-circle-check"></i></div>
        <div><h3>Confirmed</h3><p id="statConfirmed" style="font-size: 1.8rem; font-weight: bold; color: var(--dark);">0</p></div>
      </div>
      <div class="stat-box">
        <div class="stat-icon" style="background:var(--warning);"><i class="fa-solid fa-indian-rupee-sign"></i></div>
        <div><h3>Today's Sales</h3><p id="statToday" style="font-size: 1.8rem; font-weight: bold; color: var(--dark);">‚Çπ0</p></div>
      </div>
      <div class="stat-box">
        <div class="stat-icon" style="background:var(--primary);"><i class="fa-solid fa-chart-line"></i></div>
        <div><h3>Total Revenue</h3><p id="statRev" style="font-size: 1.8rem; font-weight: bold; color: var(--dark);">‚Çπ0</p></div>
      </div>
    </div>

    <div class="dashboard-content">
      <div class="filter-bar">
        <button class="tab-btn active" onclick="setFilter('all', this)">All Orders</button>
        <button class="tab-btn" onclick="setFilter('pending', this)">üïí Pending</button>
        <button class="tab-btn" onclick="setFilter('confirmed', this)">‚úÖ Confirmed</button>
      </div>

      <div id="ordersBody"></div>
    </div>
  </div>

  <div class="refresh-indicator" id="refreshIndicator">
    <i class="fa-solid fa-rotate"></i> Auto-refreshing...
  </div>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px; display: flex; align-items: center; gap: 10px;">
          <i class="fa-solid fa-pen-to-square" style="color: var(--warning);"></i> Edit Bill
      </h3>
      <div id="editItemsList" style="max-height: 250px; overflow-y: auto; padding-right: 5px;"></div>
      
      <div style="margin-top:20px; background:#f9f9f9; padding:15px; border-radius:15px;">
        <label style="font-size:0.8rem; font-weight: 700; color: #555;">Add New Item</label>
        <div style="display:flex; gap:10px; margin-top: 5px;">
          <select id="menuDropdown" style="flex:1; padding:10px; border-radius:8px; border: 1px solid #ddd;"></select>
          <button onclick="addItemToEdit()" style="background:var(--success); color:white; border:none; padding:5px 15px; border-radius:8px; cursor: pointer;"><i class="fa-solid fa-plus"></i></button>
        </div>
      </div>
      
      <button onclick="saveEditedBill()" style="width:100%; background:var(--primary); color:white; border:none; padding:15px; border-radius:12px; margin-top:20px; font-weight:bold; font-size: 1rem; cursor: pointer;">Update Order</button>
      <button onclick="closeEditModal()" style="width:100%; background:none; border:none; color:#999; margin-top:15px; cursor: pointer;">Discard Changes</button>
    </div>
  </div>

  <script>
    const OWNER_PASSWORD = '5555';
    const API_BASE_URL = 'https://mrt-cafe-api.onrender.com/api/orders';
    const MENU_API_URL = 'https://mrt-cafe-api.onrender.com/api/menu';
    
    let allOrders = [];
    let menuItems = [];
    let currentFilter = 'all';
    let currentEditingOrder = null;
    let autoRefreshInterval;

    function goToMenu() {
      window.location.href = 'index.html';
    }

    function login() {
      if(document.getElementById('ownerPassword').value === OWNER_PASSWORD) {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        loadData();
        startAutoRefresh();
      } else { 
        alert("Access Denied: Invalid PIN"); 
      }
    }

    function startAutoRefresh() {
      autoRefreshInterval = setInterval(() => {
        showRefreshIndicator();
        loadOrders();
      }, 5000); // Refresh every 5 seconds
    }

    function showRefreshIndicator() {
      const indicator = document.getElementById('refreshIndicator');
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 1000);
    }

    async function loadData() {
        try {
            const resMenu = await fetch(MENU_API_URL);
            menuItems = await resMenu.json();
            const select = document.getElementById('menuDropdown');
            select.innerHTML = menuItems.map(i => `<option value="${i.name}" data-price="${i.price}">${i.name} (‚Çπ${i.price})</option>`).join('');
            loadOrders();
        } catch(e) { 
            console.error("Error loading menu", e); 
        }
    }

    async function loadOrders() {
      try {
        const res = await fetch(API_BASE_URL);
        const data = await res.json();
        
        // Sort orders by timestamp (newest first)
        allOrders = data.sort((a, b) => {
          const timeA = a.timestamp || 0;
          const timeB = b.timestamp || 0;
          return timeB - timeA;
        });
        
        updateStats();
        displayOrders();
      } catch(e) { 
        console.error("Error loading orders", e); 
      }
    }

    function updateStats() {
      const today = new Date().toLocaleDateString('en-GB');
      const total = allOrders.length;
      const confirmed = allOrders.filter(o => o.confirmed).length;
      const totalRev = allOrders.reduce((s, o) => s + (o.total || 0), 0);
      const todayRev = allOrders.filter(o => o.date === today).reduce((s, o) => s + (o.total || 0), 0);

      document.getElementById('statTotal').innerText = total;
      document.getElementById('statConfirmed').innerText = confirmed;
      document.getElementById('statToday').innerText = `‚Çπ${todayRev}`;
      document.getElementById('statRev').innerText = `‚Çπ${totalRev}`;
    }

    function setFilter(f, btn) {
      currentFilter = f;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      displayOrders();
    }

    function displayOrders() {
      const container = document.getElementById('ordersBody');
      container.innerHTML = '';
      const filtered = allOrders.filter(o => {
          if(currentFilter === 'pending') return !o.confirmed;
          if(currentFilter === 'confirmed') return o.confirmed;
          return true;
      });

      if(filtered.length === 0) {
          container.innerHTML = `<div style="text-align:center; padding:50px; color:#888; background:white; border-radius:20px;">
            <i class="fa-solid fa-inbox" style="font-size:3rem; margin-bottom:15px; opacity:0.3;"></i>
            <p>No orders found in ${currentFilter} list.</p>
          </div>`;
          return;
      }

      filtered.forEach(order => {
        const card = document.createElement('div');
        card.className = `order-card ${order.confirmed ? 'confirmed' : ''}`;
        
        const orderTypeIcon = order.type === 'Delivery' ? 'üöö' : 'üçΩÔ∏è';
        const orderTypeBadge = `<span style="background:${order.type === 'Delivery' ? '#e8f5e9' : '#fff3e0'}; color:${order.type === 'Delivery' ? '#2e7d32' : '#e65100'}; padding:4px 12px; border-radius:12px; font-size:0.75rem; font-weight:bold;">${orderTypeIcon} ${order.type}</span>`;
        
        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px;">
            <div>
              <h3 style="color:#2d3436; font-size: 1.2rem; margin-bottom:5px;">Order #${order.orderNumber}</h3>
              <span style="font-size:0.75rem; color:#999; font-weight: 600;"><i class="fa-regular fa-clock"></i> ${order.date} | ${order.time}</span>
            </div>
            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
              ${orderTypeBadge}
              <span style="background:#f1f2f6; padding:6px 14px; border-radius:12px; font-weight:bold; color: #555;">${order.tableNumber}</span>
            </div>
          </div>
          
          <p style="margin:12px 0; color: #555;"><strong><i class="fa-solid fa-map-marker-alt"></i> Location:</strong> ${order.customerName}</p>
          ${order.contactNumber !== 'N/A' ? `<p style="margin:8px 0; color: #555;"><strong><i class="fa-solid fa-phone"></i> Contact:</strong> ${order.contactNumber}</p>` : ''}
          
          <div style="background:#fafafa; border-radius:12px; padding:15px; margin:15px 0; border: 1px solid #eee;">
            ${order.items.map(i => `<div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size: 0.95rem;">
                <span>${i.name} <strong style="color:var(--primary);">x${i.quantity}</strong></span><span>‚Çπ${i.total}</span>
            </div>`).join('')}
          </div>
          
          <div style="text-align:right; font-size:1.3rem; font-weight:800; color:var(--success);">Total Bill: ‚Çπ${order.total}</div>
          
          <div class="btn-group" style="margin-top:20px;">
            ${!order.confirmed ? `
                <button class="action-btn btn-edit" onclick="openEditModal('${order.id || order._id}')"><i class="fa-solid fa-pen-to-square"></i> Edit Bill</button>
                <button class="action-btn btn-confirm" onclick="confirmOrder('${order.id || order._id}')"><i class="fa-solid fa-check-double"></i> Confirm</button>
                <button class="action-btn btn-delete" onclick="deleteOrder('${order.id || order._id}')" style="grid-column:span 2;"><i class="fa-solid fa-trash"></i> Delete Order</button>
            ` : `
                <button class="action-btn" style="background:#e8f5e9; grid-column:span 2; color:#2e7d32; cursor:default; font-size: 0.9rem;">
                  <i class="fa-solid fa-check-circle"></i> Order Completed & Closed
                </button>
            `}
          </div>
        `;
        container.appendChild(card);
      });
    }

    function openEditModal(id) {
        const order = allOrders.find(o => (o.id || o._id) === id);
        currentEditingOrder = JSON.parse(JSON.stringify(order));
        renderEditItems();
        document.getElementById('editModal').classList.add('active');
    }

    function renderEditItems() {
        const list = document.getElementById('editItemsList');
        list.innerHTML = currentEditingOrder.items.map((item, idx) => `
            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #f1f1f1;">
                <span style="font-weight: 600;">${item.name}</span>
                <div style="display:flex; align-items:center; gap:12px;">
                    <button onclick="updateQty(${idx},-1)" style="width:28px; height:28px; border:none; border-radius:50%; background: #fee; color:#e74c3c; cursor: pointer; font-weight:bold;">-</button>
                    <strong style="min-width: 20px; text-align: center;">${item.quantity}</strong>
                    <button onclick="updateQty(${idx},1)" style="width:28px; height:28px; border:none; border-radius:50%; background: #e8f5e9; color:#2e7d32; cursor: pointer; font-weight:bold;">+</button>
                </div>
            </div>
        `).join('');
    }

    function updateQty(idx, d) {
        currentEditingOrder.items[idx].quantity += d;
        if(currentEditingOrder.items[idx].quantity <= 0) {
            currentEditingOrder.items.splice(idx,1);
        } else {
            currentEditingOrder.items[idx].total = currentEditingOrder.items[idx].quantity * currentEditingOrder.items[idx].price;
        }
        renderEditItems();
    }

    function addItemToEdit() {
        const select = document.getElementById('menuDropdown');
        const name = select.value;
        const price = parseInt(select.options[select.selectedIndex].getAttribute('data-price'));
        const ext = currentEditingOrder.items.find(i => i.name === name);
        if(ext) { 
            ext.quantity++; 
            ext.total = ext.quantity * price; 
        } else { 
            currentEditingOrder.items.push({name, price, quantity:1, total:price}); 
        }
        renderEditItems();
    }

    async function saveEditedBill() {
        currentEditingOrder.total = currentEditingOrder.items.reduce((s,i)=> s+i.total, 0);
        const id = currentEditingOrder.id || currentEditingOrder._id;
        
        try {
            await fetch(`${API_BASE_URL}/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(currentEditingOrder)
            });
            closeEditModal();
            loadOrders();
        } catch(e) {
            console.error("Error updating order:", e);
            alert("Failed to update order. Please try again.");
        }
    }

    function closeEditModal() { 
        document.getElementById('editModal').classList.remove('active'); 
    }

    async function confirmOrder(id) {
        if(confirm("Are you sure you want to confirm this order?")) {
            try {
                await fetch(`${API_BASE_URL}/${id}/confirm`, { 
                    method: 'PUT', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({confirmed: true})
                });
                loadOrders();
            } catch(e) {
                console.error("Error confirming order:", e);
                alert("Failed to confirm order. Please try again.");
            }
        }
    }

    async function deleteOrder(id) {
        if(confirm("Are you sure you want to delete this order? This action cannot be undone.")) {
            try {
                await fetch(`${API_BASE_URL}/${id}`, { 
                    method: 'DELETE'
                });
                loadOrders();
            } catch(e) {
                console.error("Error deleting order:", e);
                alert("Failed to delete order. Please try again.");
            }
        }
    }

    function logout() { 
        clearInterval(autoRefreshInterval);
        location.reload(); 
    }
  </script>
</body>
</html>
